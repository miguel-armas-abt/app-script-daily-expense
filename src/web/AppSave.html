<script>
  document.addEventListener('DOMContentLoaded', function () {
    var AppUI = window.AppUI;
    if (!AppUI) return;
    var $ = AppUI.$;

    var form = $('new-expense-form');
    if (!form) return;

    var saveBtn = $('saveBtn');

    var amountInput = $('amountInputSave');
    var categoryInput = $('categoryInputSave');
    var dateInput = $('dateInputSave');
    var commentsInput = $('commentsSave');
    var currencyInput = $('currencyInputSave');

    var touched = {};

    function markTouched(input) {
      if (!input || !input.id) return;
      touched[input.id] = true;
    }

    function setInvalidVisible(input, visible) {
      if (!input) return;
      var el = document.querySelector('[data-invalid-for="' + input.id + '"]');
      if (!el) return;
      el.classList.toggle('hidden', !visible);
    }

    function shouldShowInvalid(input) {
      if (!input) return false;
      return !!touched[input.id];
    }

    function syncValidation() {
      var inputs = [currencyInput, amountInput, dateInput, categoryInput];
      inputs.forEach(function (inp) {
        if (!inp) return;
        var show = shouldShowInvalid(inp) && !inp.checkValidity();
        setInvalidVisible(inp, show);
      });
      if (saveBtn) saveBtn.disabled = !form.checkValidity();
      return form.checkValidity();
    }

    function resetForm() {
      touched = {};

      amountInput.value = '';
      commentsInput.value = '';
      currencyInput.value = AppUI.currency.defaultCode();

      if (categoryInput) {
        categoryInput.value = '';
        if (categoryInput.options && categoryInput.options.length) categoryInput.selectedIndex = 0;
      }

      if (dateInput) dateInput.value = "<?= defaultDate ?>";

      [currencyInput, amountInput, dateInput, categoryInput].forEach(function (i) { setInvalidVisible(i, false); });
      syncValidation();
    }

    function setSavingState(saving) {
      AppUI.showLoader(!!saving);
      AppUI.setModalBusy('createExpenseModal', !!saving);
      AppUI.setBusy(saveBtn, !!saving);
    }

    function open() {
      AppUI.setModalBusy('createExpenseModal', false);
      AppUI.setModalLoading('createExpenseModal', true);
      AppUI.openModal('createExpenseModal');

      if (AppUI.categories && AppUI.categories.ensureLoaded) {
        AppUI.categories.ensureLoaded(function () {
          resetForm();
          AppUI.setModalLoading('createExpenseModal', false);
        });
        return;
      }

      resetForm();
      AppUI.setModalLoading('createExpenseModal', false);
    }

    function close() {
      AppUI.closeModal('createExpenseModal');
    }

    function wireTouched(input) {
      if (!input) return;
      input.addEventListener('input', function () { markTouched(input); syncValidation(); }, true);
      input.addEventListener('blur', function () { markTouched(input); syncValidation(); }, true);
      input.addEventListener('change', function () { markTouched(input); syncValidation(); }, true);
    }

    [currencyInput, amountInput, dateInput, categoryInput].forEach(wireTouched);

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      e.stopPropagation();

      [currencyInput, amountInput, categoryInput, dateInput].forEach(markTouched);

      if (!syncValidation()) return;

      var payload = {
        amount: amountInput.value.trim(),
        category: String(categoryInput.value || '').trim(),
        comments: commentsInput.value.trim(),
        expenseDate: dateInput.value,
        currency: AppUI.currency.normalizeCode(currencyInput.value)
      };

      setSavingState(true);

      google.script.run
        .withSuccessHandler(function (uuid) {
          setSavingState(false);

          if (window.AppSearch && window.AppSearch.upsertFromClient) {
            window.AppSearch.upsertFromClient({
              gmailMessageId: uuid,
              expenseDate: payload.expenseDate,
              amount: payload.amount,
              currency: payload.currency,
              category: payload.category,
              comments: payload.comments,
              source: 'Manual'
            });
          }

          if (window.AppSearch && window.AppSearch.clearPending) {
            window.AppSearch.clearPending(uuid);
          }

          close();
          AppUI.toast('Gasto registrado con Ã©xito.', true);
          resetForm();
        })
        .withFailureHandler(function (err) {
          setSavingState(false);
          var msg = (err && err.message) ? err.message : 'No se pudo guardar.';
          AppUI.toast(msg, false);
        })
        .saveExpense(payload);
    });

    window.AppCreate = { open: open, close: close };

    resetForm();
  });
</script>
