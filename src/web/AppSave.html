<script>
document.addEventListener('DOMContentLoaded', function () {
  var AppUI = window.AppUI;
  if (!AppUI) return;
  var $ = AppUI.$;

  var form        = $('new-expense-form');
  if (!form) return;

  var saveBtn     = $('saveBtn');
  var resetBtn    = $('resetBtnSave');
  var amountInput = $('amountInputSave');
  var categoryInp = $('categoryInputSave');
  var dateInput   = $('dateInputSave');
  var commentsInp = $('commentsSave');
  var statusArea  = $('statusAreaSave');

  function numeric(v) {
    var n = Number(String(v).replace(',', '.'));
    return !isNaN(n);
  }

  function validate() {
    var vAmount   = amountInput.value.trim();
    var vCategory = categoryInp.value.trim();
    var vDate     = dateInput.value;

    var okAmount   = vAmount.length > 0 && numeric(vAmount);
    var okCategory = vCategory.length > 0;
    var okDate     = vDate && /^\d{4}-\d{2}-\d{2}$/.test(vDate);

    amountInput.classList.toggle('is-invalid', !okAmount);
    categoryInp.classList.toggle('is-invalid', !okCategory);
    dateInput.classList.toggle('is-invalid', !okDate);

    var valid = okAmount && okCategory && okDate;
    if (saveBtn) saveBtn.disabled = !valid;
    return valid;
  }

  ['input', 'change'].forEach(function (evt) {
    amountInput.addEventListener(evt, validate);
    categoryInp.addEventListener(evt, validate);
    dateInput.addEventListener(evt, validate);
  });

  if (resetBtn) {
    resetBtn.addEventListener('click', function () {
      amountInput.value   = '';
      categoryInp.value   = '';
      commentsInp.value   = '';
      dateInput.value     = "<?= defaultDate ?>";
      validate();
    });
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    if (!validate()) return;

    var payload = {
      amount:      amountInput.value.trim(),
      category:    categoryInp.value.trim(),
      comments:    commentsInp.value.trim(),
      expenseDate: dateInput.value
    };

    statusArea.textContent = 'Guardando…';
    AppUI.setBusy(saveBtn, true);
    AppUI.showLoader(true);

    google.script.run
      .withSuccessHandler(function (uuid) {
        AppUI.setBusy(saveBtn, false);
        AppUI.showLoader(false);
        statusArea.textContent = 'Guardado correctamente.';
        AppUI.showSuccessModal('Gasto registrado con éxito. ID: ' + uuid);
        if (resetBtn) resetBtn.click();
        if (window.__refreshSearch) {
          window.__refreshSearch();
        }
      })
      .withFailureHandler(function (err) {
        AppUI.setBusy(saveBtn, false);
        AppUI.showLoader(false);
        statusArea.textContent = 'Error al guardar.';
        var msg = (err && err.message) ? err.message : 'No se pudo guardar.';
        AppUI.toast(msg, false);
      })
      .saveExpense(payload);
  });

  validate();
});
</script>
