<script>
document.addEventListener('DOMContentLoaded', function () {
  var AppUI = window.AppUI;
  if (!AppUI) return;
  var $ = AppUI.$;

  var form = $('new-expense-form');
  if (!form) return;

  var saveBtn = $('saveBtn');
  var resetBtn = $('resetBtnSave');
  var amountInput = $('amountInputSave');
  var categoryInput = $('categoryInputSave');
  var dateInput = $('dateInputSave');
  var commentsInput = $('commentsSave');
  var statusArea = $('statusAreaSave');
  var currencyInput = $('currencyInputSave');

  function validate() {
    var vAmount = amountInput.value.trim();
    var vCategory = categoryInput.value.trim();
    var vDate = dateInput.value;
    var vCurrency = currencyInput.value.trim();

    var okAmount = vAmount.length > 0 && AppUI.isNumeric(vAmount);
    var okCategory = vCategory.length > 0;
    var okDate = vDate && /^\d{4}-\d{2}-\d{2}$/.test(vDate);
    var okCurrency = vCurrency.length > 0;

    amountInput.classList.toggle('is-invalid', !okAmount);
    categoryInput.classList.toggle('is-invalid', !okCategory);
    dateInput.classList.toggle('is-invalid', !okDate);

    var valid = okAmount && okCategory && okDate && okCurrency;
    if (saveBtn) saveBtn.disabled = !valid;
    return valid;
  }

  ['input','change'].forEach(function (evt) {
    amountInput.addEventListener(evt, validate);
    categoryInput.addEventListener(evt, validate);
    dateInput.addEventListener(evt, validate);
    currencyInput.addEventListener(evt, validate);
  });

  if (resetBtn) {
    resetBtn.addEventListener('click', function () {
      amountInput.value = '';
      categoryInput.value = '';
      commentsInput.value = '';
      dateInput.value = "<?= defaultDate ?>";
      currencyInput.value = AppUI.currency.defaultCode();
      validate();
    });
  }

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    if (!validate()) return;

    var payload = {
      amount: amountInput.value.trim(),
      category: categoryInput.value.trim(),
      comments: commentsInput.value.trim(),
      expenseDate: dateInput.value,
      currency: AppUI.currency.normalizeCode(currencyInput.value)
    };

    statusArea.textContent = 'Guardando…';
    AppUI.setBusy(saveBtn, true);

    google.script.run
      .withSuccessHandler(function (uuid) {
        AppUI.setBusy(saveBtn, false);
        statusArea.textContent = 'Guardado correctamente.';

        if (window.AppSearch && window.AppSearch.upsertFromClient) {
          window.AppSearch.upsertFromClient({
            gmailMessageId: uuid,
            expenseDate: payload.expenseDate,
            amount: payload.amount,
            currency: payload.currency,
            category: payload.category,
            comments: payload.comments,
            source: 'Manual'
          });
        }

        AppUI.setActiveTab('search');
        AppUI.toast('Gasto registrado con éxito.', true);
        if (resetBtn) resetBtn.click();
      })
      .withFailureHandler(function (err) {
        AppUI.setBusy(saveBtn, false);
        statusArea.textContent = 'Error al guardar.';
        var msg = (err && err.message) ? err.message : 'No se pudo guardar.';
        AppUI.toast(msg, false);
      })
      .saveExpense(payload);
  });

  validate();
});
</script>
