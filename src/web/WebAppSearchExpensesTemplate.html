<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Consulta de gastos</title>

  <!-- Bootstrap / Icons -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Estilos globales -->
  <?!= HtmlService.createHtmlOutputFromFile('WebAppExpenseStyles').getContent(); ?>
</head>
<body>
  <!-- Loader global -->
  <div id="globalLoader" class="loader-overlay d-none">
    <div class="spinner-border loader-spinner" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Header -->
  <header class="py-3">
    <div class="container-narrow d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <div class="btn-icon bg-light border">
          <i class="fa-solid fa-wallet"></i>
        </div>
        <div>
          <h1 class="h5 mb-0 fw-bold">Daily Expense — Consulta de gastos</h1>
          <small class="text-muted">Filtra, pagina y edita rápidamente</small>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="?action=new" title="Nuevo">
          <i class="fa-solid fa-plus"></i> Nuevo
        </a>
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm" aria-label="Cambiar tema">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container-narrow">
    <div class="card-surface p-3 p-md-4">
      <!-- Filtros -->
      <form id="filtersForm" class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Buscar</label>
          <input id="q" class="form-control" placeholder="Categoría, comentarios, fuente…" autocomplete="off" />
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Desde</label>
          <input id="from" type="date" class="form-control" />
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Hasta</label>
          <input id="to" type="date" class="form-control" />
        </div>
        <div class="col-12 col-md-2">
          <label for="categoryInput" class="form-label">Categoría</label>
          <input id="categoryInput" list="categoryOptions" class="form-control" placeholder="Todas" autocomplete="off" />
          <datalist id="categoryOptions">
            <? for (var i = 0; i < categories.length; i++) { ?>
              <option value="<?= categories[i] ?>"></option>
            <? } ?>
          </datalist>
        </div>
        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-brand">
            <i class="fa-solid fa-magnifying-glass me-2"></i> Buscar
          </button>
          <button type="button" id="clearBtn" class="btn btn-outline-secondary">
            <i class="fa-solid fa-eraser me-2"></i> Limpiar
          </button>
        </div>
      </form>

      <!-- Resultados -->
      <div class="table-responsive mt-4">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Importe</th>
              <th>Mon.</th>
              <th>Categoría</th>
              <th>Comentarios</th>
              <th>Origen</th>
              <th style="width:1%">Acciones</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
          <span id="pageInfo">—</span>
        </div>
        <div class="btn-group">
          <button id="prevBtn" class="btn btn-outline-secondary btn-sm" disabled>
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <button id="nextBtn" class="btn btn-outline-secondary btn-sm" disabled>
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Toasts host -->
  <div id="toastHost" class="toast-container"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <script>
    (function(){
      // ===== Theme toggle
      var themeBtn = document.getElementById('themeToggle');
      function applyTheme(mode){
        document.body.classList.toggle('dark-mode', mode === 'dark');
        themeBtn.innerHTML = '<i class="fa-solid ' + (mode === 'dark' ? 'fa-sun' : 'fa-moon') + '"></i>';
      }
      var saved = localStorage.getItem('dex_theme');
      applyTheme(saved || 'light');
      themeBtn.addEventListener('click', function(){
        var mode = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        localStorage.setItem('dex_theme', mode);
        applyTheme(mode);
      });

      // ===== Helpers
      var $ = function(id){ return document.getElementById(id); };
      var loader = $('globalLoader');
      function showLoader(show){ loader.classList.toggle('d-none', !show); }

      function toast(msg, ok){
        var host = $('toastHost');
        var el = document.createElement('div');
        el.className = 'toast align-items-center text-bg-' + (ok ? 'success' : 'danger') + ' border-0';
        el.innerHTML = '<div class="d-flex"><div class="toast-body">'+ msg +'</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>';
        host.appendChild(el);
        var t = new bootstrap.Toast(el, { delay: 3000 });
        t.show();
        el.addEventListener('hidden.bs.toast', function(){ el.remove(); });
      }

      // ===== Estado de paginación
      var state = {
        page: 1,
        pageSize: 10,
        total: 0,
        totalPages: 0,
        filters: { q:'', from:'', to:'', category:'' }
      };

      // ===== DOM refs
      var rows = $('rows');
      var pageInfo = $('pageInfo');
      var prevBtn = $('prevBtn');
      var nextBtn = $('nextBtn');

      var form = $('filtersForm');
      var q = $('q');
      var from = $('from');
      var to = $('to');
      var categoryInput = $('categoryInput');
      var clearBtn = $('clearBtn');

      function buildEditUrl(item){
        // Reutiliza tu UI de edición enviando lo necesario por querystring
        var p = new URLSearchParams({
          action: 'edit',
          gmailMessageId: item.gmailMessageId || '',
          amount: String(item.amount ?? ''),
          expenseDate: item.expenseDate || '',
          source: item.source || '',
          kind: item.kind || '',
          comments: item.comments || ''
        });
        return '?' + p.toString();
      }

      function render(items){
        rows.innerHTML = '';
        if (!items || !items.length){
          rows.innerHTML = '<tr><td colspan="7" class="text-muted">Sin resultados.</td></tr>';
          return;
        }
        items.forEach(function(it){
          var tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.expenseDate ?? ''}</td>
            <td>${(it.amount ?? '')}</td>
            <td>${it.currency ?? ''}</td>
            <td>${it.category ?? ''}</td>
            <td class="text-truncate" title="${(it.comments ?? '').replace(/"/g,'&quot;')}">${it.comments ?? ''}</td>
            <td>${it.source ?? ''}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-brand" href="${buildEditUrl(it)}" title="Editar">
                <i class="fa-solid fa-pen-to-square"></i>
              </a>
            </td>
          `;
          rows.appendChild(tr);
        });
      }

      function updatePager(){
        pageInfo.textContent = (state.totalPages > 0)
            ? `Página ${state.page} de ${state.totalPages} · ${state.total} registros`
            : '—';
        prevBtn.disabled = state.page <= 1;
        nextBtn.disabled = state.page >= state.totalPages;
    }

      function fetchData(){
        showLoader(true);
        google.script.run
          .withSuccessHandler(function(res){
            showLoader(false);
            if (!res){ render([]); state.total = 0; state.totalPages = 0; updatePager(); return; }
            state.total = res.total || 0;
            state.totalPages = res.totalPages || 0;
            render(res.items || []);
            updatePager();
          })
          .withFailureHandler(function(err){
            showLoader(false);
            toast((err && err.message) ? err.message : 'No se pudo obtener los datos', false);
          })
          .getExpenses({
            q: state.filters.q,
            from: state.filters.from,
            to: state.filters.to,
            category: state.filters.category,
            page: state.page,
            pageSize: state.pageSize
          });
      }

      // Eventos filtros
      form.addEventListener('submit', function(e){
        e.preventDefault();
        state.page = 1;
        state.filters = {
          q: q.value.trim(),
          from: from.value || '',
          to: to.value || '',
          category: categoryInput.value.trim()
        };
        fetchData();
      });

      clearBtn.addEventListener('click', function(){
        q.value = '';
        from.value = '';
        to.value = '';
        categoryInput.value = '';
        state.page = 1;
        state.filters = { q:'', from:'', to:'', category:'' };
        fetchData();
      });

      prevBtn.addEventListener('click', function(){
        if (state.page > 1){ state.page--; fetchData(); }
      });
      nextBtn.addEventListener('click', function(){
        if (state.page < state.totalPages){ state.page++; fetchData(); }
      });

      // Primera carga
      fetchData();
    })();
  </script>
</body>
</html>
