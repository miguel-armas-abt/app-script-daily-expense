<script>
  document.addEventListener('DOMContentLoaded', function () {
    var AppUI = window.AppUI;
    if (!AppUI) return;
    var $ = AppUI.$;

    var rows = $('rows');
    if (!rows) return;

    var cardsContainer = $('cardsContainer');
    var pageInfo = $('pageInfo');
    var prevBtn = $('prevBtn');
    var nextBtn = $('nextBtn');

    var searchBtnMobile = $('searchBtn');
    var clearBtnMobile = $('clearBtn');
    var searchBtnDesktop = $('searchBtnDesktop');
    var clearBtnDesktop = $('clearBtnDesktop');

    var whatEverInpDesktop = $('whatEverText');
    var fromInpDesktop = $('from');
    var toInpDesktop = $('to');
    var categoryInputDesktop = $('categoryInputSearch');
    var currencyInputDesktop = $('currencyInputSearch');

    var whatEverInpMobile = $('whatEverTextMobile');
    var fromInpMobile = $('fromMobile');
    var toInpMobile = $('toMobile');
    var categoryInputMobile = $('categoryInputSearchMobile');
    var currencyInputMobile = $('currencyInputSearchMobile');

    var state = {
      page: 1,
      total: 0,
      totalPages: 0,
      filters: { whatEverText: '', from: '', to: '', category: '', currency: '' },
      items: [],
      pendingId: null
    };

    function escapeAttr(v) {
      return String(v || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function buildPayloadAttr(it) {
      return JSON.stringify(it).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function firstValue() {
      for (var i = 0; i < arguments.length; i++) {
        var el = arguments[i];
        if (el && el.value != null) return String(el.value || '').trim();
      }
      return '';
    }

    function setBoth(a, b, value) {
      var v = value == null ? '' : String(value);
      if (a) a.value = v;
      if (b) b.value = v;
    }

    function syncInputsFromDesktopToMobile() {
      setBoth(whatEverInpMobile, whatEverInpDesktop, whatEverInpDesktop ? whatEverInpDesktop.value : '');
      setBoth(fromInpMobile, fromInpDesktop, fromInpDesktop ? fromInpDesktop.value : '');
      setBoth(toInpMobile, toInpDesktop, toInpDesktop ? toInpDesktop.value : '');
      setBoth(currencyInputMobile, currencyInputDesktop, currencyInputDesktop ? currencyInputDesktop.value : '');
      setBoth(categoryInputMobile, categoryInputDesktop, categoryInputDesktop ? categoryInputDesktop.value : '');
    }

    function syncInputsFromMobileToDesktop() {
      setBoth(whatEverInpDesktop, whatEverInpMobile, whatEverInpMobile ? whatEverInpMobile.value : '');
      setBoth(fromInpDesktop, fromInpMobile, fromInpMobile ? fromInpMobile.value : '');
      setBoth(toInpDesktop, toInpMobile, toInpMobile ? toInpMobile.value : '');
      setBoth(currencyInputDesktop, currencyInputMobile, currencyInputMobile ? currencyInputMobile.value : '');
      setBoth(categoryInputDesktop, categoryInputMobile, categoryInputMobile ? categoryInputMobile.value : '');
    }

    function updatePager() {
      if (pageInfo) {
        pageInfo.textContent = (state.totalPages > 0)
          ? 'Página ' + state.page + ' de ' + state.totalPages + ' · ' + state.total + ' registros'
          : '—';
      }
      if (prevBtn) prevBtn.disabled = state.page <= 1;
      if (nextBtn) nextBtn.disabled = state.page >= state.totalPages;
    }

    function setChipState(key, value) {
      var chip = document.getElementById('chip-' + key);
      var iconWrap = document.getElementById('chipIcon-' + key);
      if (!chip || !iconWrap) return;

      var val = String(value == null ? '' : value).trim();
      var active = !!val;

      chip.classList.toggle('border-dashed', !active);
      chip.classList.toggle('border-gray-300', !active);
      chip.classList.toggle('border-gray-200', active);
      chip.classList.toggle('bg-white', true);

      iconWrap.innerHTML = active
        ? '<i class="fa-solid fa-xmark"></i>'
        : '<i class="fa-solid fa-plus"></i>';

      var valueEl = document.getElementById('chipValue-' + key);
      if (valueEl) {
        valueEl.textContent = val;
        valueEl.classList.toggle('hidden', !active);
      }
    }

    function syncChips() {
      setChipState('whatEverText', firstValue(whatEverInpDesktop, whatEverInpMobile));
      setChipState('from', firstValue(fromInpDesktop, fromInpMobile));
      setChipState('to', firstValue(toInpDesktop, toInpMobile));
      setChipState('currency', firstValue(currencyInputDesktop, currencyInputMobile));
      setChipState('category', firstValue(categoryInputDesktop, categoryInputMobile));
    }

    function normalizeClientExpense(expense) {
      if (!expense) return expense;

      if (expense.currency) {
        expense.currency = AppUI.currency.normalizeCode(expense.currency);
        expense.currencySymbol = AppUI.currency.symbol(expense.currency);
      }

      if (expense.isBelowLimit == null && AppUI.expenses && AppUI.expenses.computeIsBelowLimit) {
        expense.isBelowLimit = AppUI.expenses.computeIsBelowLimit(expense.amount, expense.category);
      }

      return expense;
    }

    function fetchData() {
      AppUI.showLoader(true);

      google.script.run
        .withSuccessHandler(function (res) {
          AppUI.showLoader(false);

          if (!res) {
            state.items = [];
            state.total = 0;
            state.totalPages = 0;
            updatePager();
            render();
            return;
          }

          state.total = res.total || 0;
          state.totalPages = res.totalPages || 0;
          state.page = res.page || 1;
          state.items = (res.items || []).map(function (it) { return normalizeClientExpense(it) || it; });
          state.pendingId = null;

          updatePager();
          render();
        })
        .withFailureHandler(function (err) {
          AppUI.showLoader(false);
          var msg = (err && err.message) ? err.message : 'No se pudo obtener los datos';
          AppUI.toast(msg, false);
        })
        .findExpensesByFilters({
          whatEverText: state.filters.whatEverText,
          from: state.filters.from,
          to: state.filters.to,
          category: state.filters.category,
          currency: state.filters.currency,
          page: state.page
        });
    }

    function renderLimitDot(isBelowLimit) {
      var ok = isBelowLimit === true;
      var klass = ok
        ? 'bg-green-500 ring-green-200 dark:ring-green-900/40'
        : 'bg-red-500 ring-red-200 dark:ring-red-900/40';
      var title = ok ? 'Debajo del límite' : 'Supera el límite';
      return '<span class="inline-block h-3 w-3 rounded-full ring-2 ' + klass + '" title="' + title + '" aria-label="' + title + '"></span>';
    }

    function renderDesktopRow(it) {
      var fullComment = it.comments || '';
      var displayComment = fullComment.length > 40 ? fullComment.slice(0, 40) + '…' : fullComment;

      var payload = buildPayloadAttr(it);
      var isPending = state.pendingId && String(it.gmailMessageId || '') === String(state.pendingId || '');

      var id = escapeAttr(it.gmailMessageId || '');
      var ddId = 'dd-act-' + id;

      var tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-900 ' + (isPending ? 'bg-gray-50 dark:bg-gray-900' : '');
      tr.setAttribute('data-id', String(it.gmailMessageId || ''));

      tr.innerHTML =
        '<td class="px-4 py-3 whitespace-nowrap">' + escapeAttr(it.expenseDate || '') + '</td>' +
        '<td class="px-4 py-3 whitespace-nowrap font-semibold">' + escapeAttr((it.currencySymbol ?? '') + (it.amount ?? '')) + '</td>' +
        '<td class="px-4 py-3 whitespace-nowrap">' + renderLimitDot(it.isBelowLimit) + '</td>' +
        '<td class="px-4 py-3 whitespace-nowrap">' + escapeAttr(it.category ?? '') + '</td>' +
        '<td class="px-4 py-3" title="' + escapeAttr(fullComment) + '">' + escapeAttr(displayComment) + '</td>' +
        '<td class="px-4 py-3 text-right">' +
          '<div class="relative inline-block text-left">' +
            '<button type="button" class="inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white p-2 text-gray-700 hover:bg-gray-50 dark:border-gray-800 dark:bg-gray-950 dark:text-gray-200 dark:hover:bg-gray-900" ' +
                    'data-action-toggle="' + ddId + '" aria-label="Acciones">' +
              '<i class="fa-solid fa-ellipsis-vertical"></i>' +
            '</button>' +
            '<div id="' + ddId + '" class="absolute right-0 z-20 mt-2 hidden w-44 rounded-xl border border-gray-200 bg-white p-1 shadow-lg dark:border-gray-800 dark:bg-gray-950">' +
              '<button type="button" class="w-full rounded-lg px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-900" data-edit="' + payload + '">' +
                '<i class="fa-solid fa-pen-to-square mr-2"></i>Editar' +
              '</button>' +
              '<button type="button" class="w-full rounded-lg px-3 py-2 text-left text-sm text-red-600 hover:bg-gray-50 dark:hover:bg-gray-900" data-delete="' + id + '">' +
                '<i class="fa-solid fa-trash mr-2"></i>Eliminar' +
              '</button>' +
            '</div>' +
          '</div>' +
        '</td>';

      return tr;
    }

    function renderMobileCard(it) {
      var isPending = state.pendingId && String(it.gmailMessageId || '') === String(state.pendingId || '');
      var payload = buildPayloadAttr(it);

      var id = escapeAttr(it.gmailMessageId || '');
      var ddId = 'dd-mact-' + id;

      var card = document.createElement('div');
      card.className = 'rounded-2xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-800 dark:bg-gray-950 ' + (isPending ? 'ring-1 ring-gray-300 dark:ring-gray-700' : '');
      card.setAttribute('data-id', String(it.gmailMessageId || ''));

      var title = it.comments ? escapeAttr(it.comments) : '<span class="text-gray-400">Sin comentarios</span>';
      var category = escapeAttr(it.category || 'Sin categoría');
      var date = escapeAttr(it.expenseDate || '');
      var amount = escapeAttr((it.currencySymbol ?? '') + (it.amount ?? ''));
      var dot = renderLimitDot(it.isBelowLimit);

      card.innerHTML =
        '<div class="flex items-start justify-between gap-3">' +
          '<div class="min-w-0">' +
            '<div class="truncate font-semibold" title="' + escapeAttr(it.comments || '') + '">' + title + '</div>' +
            '<div class="mt-1 text-xs text-gray-500 dark:text-gray-400">' + category + ' · ' + date + '</div>' +
          '</div>' +
          '<div class="flex flex-col items-end gap-2">' +
            '<div class="flex items-center gap-2 font-semibold">' +
              '<span>' + amount + '</span>' +
              '<span>' + dot + '</span>' +
            '</div>' +
            '<div class="relative">' +
              '<button type="button" class="inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white p-2 text-gray-700 hover:bg-gray-50 dark:border-gray-800 dark:bg-gray-950 dark:text-gray-200 dark:hover:bg-gray-900" data-action-toggle="' + ddId + '" aria-label="Acciones">' +
                '<i class="fa-solid fa-ellipsis"></i>' +
              '</button>' +
              '<div id="' + ddId + '" class="absolute right-0 z-20 mt-2 hidden w-40 rounded-xl border border-gray-200 bg-white p-1 shadow-lg dark:border-gray-800 dark:bg-gray-950">' +
                '<button type="button" class="w-full rounded-lg px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-900" data-edit="' + payload + '">' +
                  '<i class="fa-solid fa-pen-to-square mr-2"></i>Editar' +
                '</button>' +
                '<button type="button" class="w-full rounded-lg px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 dark:hover:bg-gray-900" data-delete="' + id + '">' +
                  '<i class="fa-solid fa-trash mr-2"></i>Eliminar' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      return card;
    }

    function render() {
      rows.innerHTML = '';
      if (cardsContainer) cardsContainer.innerHTML = '';

      if (!state.items || !state.items.length) {
        rows.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-sm text-gray-500 dark:text-gray-400">Sin resultados.</td></tr>';
        if (cardsContainer) cardsContainer.innerHTML = '<div class="text-center text-sm text-gray-500 dark:text-gray-400">Sin resultados.</div>';
        return;
      }

      state.items.forEach(function (it) {
        rows.appendChild(renderDesktopRow(it));
        if (cardsContainer) cardsContainer.appendChild(renderMobileCard(it));
      });
    }

    function upsertFromClient(expense) {
      if (!expense || !expense.gmailMessageId) return;

      expense = normalizeClientExpense(expense);

      var id = String(expense.gmailMessageId);
      var idx = state.items.findIndex(function (it) { return String(it.gmailMessageId || '') === id; });

      if (idx >= 0) state.items[idx] = Object.assign({}, state.items[idx], expense);
      else { state.items.unshift(expense); state.total += 1; }

      state.pendingId = id;
      render();
    }

    function removeFromClient(id) {
      if (!id) return;
      var idStr = String(id);
      var idx = state.items.findIndex(function (it) { return String(it.gmailMessageId || '') === idStr; });
      if (idx >= 0) { state.items.splice(idx, 1); state.total = Math.max(0, state.total - 1); }
      render();
    }

    function markPending(id) { state.pendingId = id || null; render(); }
    function clearPending(id) { if (!id || String(id) === String(state.pendingId || '')) { state.pendingId = null; render(); } }

    function readFilters() {
      return {
        whatEverText: firstValue(whatEverInpDesktop, whatEverInpMobile),
        from: firstValue(fromInpDesktop, fromInpMobile),
        to: firstValue(toInpDesktop, toInpMobile),
        category: firstValue(categoryInputDesktop, categoryInputMobile),
        currency: firstValue(currencyInputDesktop, currencyInputMobile)
      };
    }

    function applyFiltersAndSearch() {
      syncInputsFromMobileToDesktop();
      syncInputsFromDesktopToMobile();

      state.page = 1;
      state.filters = readFilters();
      syncChips();
      fetchData();
    }

    function clearFiltersAndSearch() {
      setBoth(whatEverInpDesktop, whatEverInpMobile, '');
      setBoth(fromInpDesktop, fromInpMobile, '');
      setBoth(toInpDesktop, toInpMobile, '');
      setBoth(categoryInputDesktop, categoryInputMobile, '');
      setBoth(currencyInputDesktop, currencyInputMobile, '');

      state.page = 1;
      state.filters = { whatEverText: '', from: '', to: '', category: '', currency: '' };
      syncChips();
      fetchData();
    }

    if (searchBtnMobile) searchBtnMobile.addEventListener('click', applyFiltersAndSearch);
    if (searchBtnDesktop) searchBtnDesktop.addEventListener('click', applyFiltersAndSearch);

    if (clearBtnMobile) clearBtnMobile.addEventListener('click', clearFiltersAndSearch);
    if (clearBtnDesktop) clearBtnDesktop.addEventListener('click', clearFiltersAndSearch);

    if (prevBtn) prevBtn.addEventListener('click', function () { if (state.page > 1) { state.page--; fetchData(); } });
    if (nextBtn) nextBtn.addEventListener('click', function () { if (state.page < state.totalPages) { state.page++; fetchData(); } });

    function closeAllActionMenus() {
      var menus = document.querySelectorAll('[id^="dd-act-"], [id^="dd-act-m-"], [id^="dd-mact-"]');
      menus.forEach(function (m) { m.classList.add('hidden'); });
    }

    function toggleActionMenu(id) {
      if (!id) return;
      var menu = document.getElementById(id);
      if (!menu) return;

      var willOpen = menu.classList.contains('hidden');
      closeAllActionMenus();
      menu.classList.toggle('hidden', !willOpen);
    }

    function openEditModal(item) {
      if (window.AppUpdate && window.AppUpdate.openWithItem) {
        window.AppUpdate.openWithItem(item);
        return;
      }
      if (window.__setUpdateDataFromSearch) window.__setUpdateDataFromSearch(item);
    }

    function requestDeleteExpense(id) {
      markPending(id);

      if (AppUI.confirm && AppUI.confirm.setLoading) {
        AppUI.confirm.setLoading(true, { label: 'Eliminando...' });
      }

      google.script.run
        .withSuccessHandler(function (res) {
          if (AppUI.confirm && AppUI.confirm.setLoading) AppUI.confirm.setLoading(false);
          if (AppUI.confirm && AppUI.confirm.close) AppUI.confirm.close();

          if (res === true) { removeFromClient(id); AppUI.toast('Gasto eliminado correctamente.', true); }
          else { clearPending(id); AppUI.toast('No se pudo eliminar el registro.', false); }
        })
        .withFailureHandler(function (err) {
          if (AppUI.confirm && AppUI.confirm.setLoading) AppUI.confirm.setLoading(false);
          if (AppUI.confirm && AppUI.confirm.close) AppUI.confirm.close();

          clearPending(id);
          var msg = (err && err.message) ? err.message : 'No se pudo eliminar el registro.';
          AppUI.toast(msg, false);
        })
        .deleteExpense({ gmailMessageId: id });
    }

    function askDeleteExpense(id) {
      if (!AppUI.confirm || !AppUI.confirm.open) return;

      AppUI.confirm.open({
        title: 'Eliminar gasto',
        message: '¿Estás seguro de eliminar este gasto?',
        confirmLabel: 'Eliminar',
        cancelLabel: 'Cancelar',
        iconHtml: '<i class="fa-solid fa-trash"></i>',
        confirmClassName: 'inline-flex items-center justify-center rounded-xl bg-red-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed'
      }).then(function (ok) {
        if (!ok) return;
        requestDeleteExpense(id);
      });
    }

    function handleActionClick(e) {
      var toggleBtn = e.target.closest('[data-action-toggle]');
      if (toggleBtn) {
        e.preventDefault();
        e.stopPropagation();
        toggleActionMenu(toggleBtn.getAttribute('data-action-toggle'));
        return;
      }

      var editBtn = e.target.closest('[data-edit]');
      if (editBtn) {
        closeAllActionMenus();
        var raw = editBtn.getAttribute('data-edit');
        try {
          var item = JSON.parse(raw.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>'));
          openEditModal(item);
        } catch (err) {
          AppUI.toast('No se pudo abrir el registro para edición.', false);
        }
        return;
      }

      var delBtn = e.target.closest('[data-delete]');
      if (delBtn) {
        closeAllActionMenus();
        var id = delBtn.getAttribute('data-delete');
        if (!id) return;
        askDeleteExpense(id);
      }
    }

    rows.addEventListener('click', handleActionClick);
    document.addEventListener('click', function (ev) {
      var t = ev && ev.target;
      if (!t) return;
      if (t.closest && (t.closest('[data-action-toggle]') || t.closest('[id^="dd-act-"]') || t.closest('[id^="dd-act-m-"]') || t.closest('[id^="dd-mact-"]'))) return;
      closeAllActionMenus();
    });
    if (cardsContainer) cardsContainer.addEventListener('click', handleActionClick);

    function bindChipClear(chipId, inputEl) {
      var chip = document.getElementById(chipId);
      if (!chip || !inputEl) return;
      chip.addEventListener('click', function (e) {
        var val = String(inputEl.value || '').trim();
        if (!val) return;
        var icon = chip.querySelector('span');
        if (e.target === icon || icon.contains(e.target) || e.altKey) {
          inputEl.value = '';
          syncInputsFromDesktopToMobile();
          syncChips();
          applyFiltersAndSearch();
        }
      });
    }

    bindChipClear('chip-whatEverText', whatEverInpDesktop);
    bindChipClear('chip-from', fromInpDesktop);
    bindChipClear('chip-to', toInpDesktop);
    bindChipClear('chip-currency', currencyInputDesktop);
    bindChipClear('chip-category', categoryInputDesktop);

    [whatEverInpDesktop, fromInpDesktop, toInpDesktop, currencyInputDesktop, categoryInputDesktop].forEach(function (el) {
      if (!el) return;
      el.addEventListener('input', function () { syncInputsFromDesktopToMobile(); syncChips(); });
      el.addEventListener('change', function () { syncInputsFromDesktopToMobile(); syncChips(); });
    });

    [whatEverInpMobile, fromInpMobile, toInpMobile, currencyInputMobile, categoryInputMobile].forEach(function (el) {
      if (!el) return;
      el.addEventListener('input', function () { syncInputsFromMobileToDesktop(); syncChips(); });
      el.addEventListener('change', function () { syncInputsFromMobileToDesktop(); syncChips(); });
    });

    window.AppSearch = {
      upsertFromClient: upsertFromClient,
      removeFromClient: removeFromClient,
      markPending: markPending,
      clearPending: clearPending,
      refreshFromBackend: fetchData
    };

    window.__refreshSearch = function () { fetchData(); };

    syncInputsFromDesktopToMobile();
    syncChips();
    fetchData();
  });
</script>
