<script>
  document.addEventListener('DOMContentLoaded', function () {
    var AppUI = window.AppUI;
    if (!AppUI) return;
    var $ = AppUI.$;

    var rows = $('rows');
    if (!rows) return;
    var cardsContainer = $('cardsContainer');

    var pageInfo = $('pageInfo');
    var prevBtn = $('prevBtn');
    var nextBtn = $('nextBtn');
    var form = $('filtersForm');
    var whatEverInp = $('whatEverText');
    var fromInp = $('from');
    var toInp = $('to');
    var categoryInput = $('categoryInputSearch');
    var clearBtn = $('clearBtn');
    var filtersWrapper = $('filtersWrapper');
    var toggleFiltersBtn = $('toggleFiltersBtn');
    var currencyInput = $('currencyInputSearch');

    var state = {
      page: 1,
      total: 0,
      totalPages: 0,
      filters: { whatEverText: '', from: '', to: '', category: '' },
      items: [],
      pendingId: null
    };

    function updatePager() {
      if (!pageInfo) return;
      pageInfo.textContent = (state.totalPages > 0)
        ? 'Página ' + state.page + ' de ' + state.totalPages + ' · ' + state.total + ' registros'
        : '—';
      if (prevBtn) prevBtn.disabled = state.page <= 1;
      if (nextBtn) nextBtn.disabled = state.page >= state.totalPages;
    }

    function render() {
      var items = state.items;
      rows.innerHTML = '';
      if (cardsContainer) cardsContainer.innerHTML = '';

      if (!items || !items.length) {
        rows.innerHTML = '<tr><td colspan="5" class="text-muted">Sin resultados.</td></tr>';
        if (cardsContainer) {
          cardsContainer.innerHTML = '<p class="text-muted small text-center mb-0">Sin resultados.</p>';
        }
        return;
      }

      items.forEach(function (it) {
        var fullComment = it.comments || '';
        var displayComment = fullComment;
        if (displayComment.length > 40) {
          displayComment = displayComment.slice(0, 40) + '…';
        }

        var payload = JSON.stringify(it)
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        var isPending = state.pendingId && String(it.gmailMessageId || '') === String(state.pendingId || '');
        var openStrong = isPending ? '<strong>' : '';
        var closeStrong = isPending ? '</strong>' : '';

        // desktop row
        var tr = document.createElement('tr');
        if (isPending) tr.classList.add('table-warning');
        tr.setAttribute('data-id', String(it.gmailMessageId || ''));

        tr.innerHTML = ''
          + '<td>' + openStrong + (it.expenseDate || '') + closeStrong + '</td>'
          + '<td>' + openStrong + (it.currencySymbol ?? '') + (it.amount ?? '') + closeStrong + '</td>'
          + '<td>' + openStrong + (it.category ?? '') + closeStrong + '</td>'
          + '<td class="text-truncate" title="' + fullComment.replace(/"/g, '&quot;') + '">'
          + openStrong + displayComment + closeStrong + '</td>'
          + '<td class="text-end">'
          + '  <div class="dropdown">'
          + '    <button class="btn btn-icon btn-ghost" type="button" data-bs-toggle="dropdown" aria-expanded="false">'
          + '      <i class="fa-solid fa-ellipsis-vertical"></i>'
          + '    </button>'
          + '    <ul class="dropdown-menu dropdown-menu-end">'
          + '      <li>'
          + '        <button type="button" class="dropdown-item" data-edit="' + payload + '">'
          + '          <i class="fa-solid fa-pen-to-square me-2"></i>Editar'
          + '        </button>'
          + '      </li>'
          + '      <li>'
          + '        <button type="button" class="dropdown-item text-danger" data-delete="' + (it.gmailMessageId || '') + '">'
          + '          <i class="fa-solid fa-trash me-2"></i>Eliminar'
          + '        </button>'
          + '      </li>'
          + '    </ul>'
          + '  </div>'
          + '</td>';

        rows.appendChild(tr);

        // mobile card
        if (cardsContainer) {
          var card = document.createElement('article');
          card.className = 'expense-card';
          card.setAttribute('data-id', String(it.gmailMessageId || ''));
          if (isPending) card.classList.add('expense-card-pending');

          var safeFullComment = fullComment.replace(/"/g, '&quot;');

          card.innerHTML = ''
            + '<div class="expense-card-main">'
            + '  <div class="expense-card-title" title="' + safeFullComment + '">'
            + (fullComment
              ? fullComment
              : '<span class="text-muted">Sin comentarios</span>')
            + '  </div>'
            + '  <div class="expense-card-subtitle">'
            + (it.category || 'Sin categoría')
            + '  </div>'
            + '  <div class="expense-card-comment">'
            + (it.expenseDate || '')
            + '  </div>'
            + '</div>'
            + '<div class="expense-card-meta">'
            + '  <div class="dropdown">'
            + '    <button class="btn btn-icon btn-ghost" type="button" data-bs-toggle="dropdown" aria-expanded="false">'
            + '      <i class="fa-solid fa-ellipsis"></i>'
            + '    </button>'
            + '    <ul class="dropdown-menu dropdown-menu-end">'
            + '      <li>'
            + '        <button type="button" class="dropdown-item" data-edit="' + payload + '">'
            + '          <i class="fa-solid fa-pen-to-square me-2"></i>Editar'
            + '        </button>'
            + '      </li>'
            + '      <li>'
            + '        <button type="button" class="dropdown-item text-danger" data-delete="' + (it.gmailMessageId || '') + '">'
            + '          <i class="fa-solid fa-trash me-2"></i>Eliminar'
            + '        </button>'
            + '      </li>'
            + '    </ul>'
            + '  </div>'
            + '  <div class="expense-card-amount">' + (it.currencySymbol ?? '') + (it.amount ?? '') + '</div>'
            + '</div>';

          cardsContainer.appendChild(card);
        }
      });
    }

    function fetchData() {
      AppUI.showLoader(true);
      google.script.run
        .withSuccessHandler(function (res) {
          AppUI.showLoader(false);
          if (!res) {
            state.items = [];
            state.total = 0;
            state.totalPages = 0;
            updatePager();
            render();
            return;
          }
          state.total = res.total || 0;
          state.totalPages = res.totalPages || 0;
          state.page = res.page || 1;
          state.items = res.items || [];
          state.pendingId = null;
          updatePager();
          render();
        })
        .withFailureHandler(function (err) {
          AppUI.showLoader(false);
          var msg = (err && err.message) ? err.message : 'No se pudo obtener los datos';
          AppUI.toast(msg, false);
        })
        .findExpensesByFilters({
          whatEverText: state.filters.whatEverText,
          from: state.filters.from,
          to: state.filters.to,
          category: state.filters.category,
          currency: state.filters.currency,
          page: state.page
        });
    }

    function symbolFromCurrency(code) {
      return AppUI.currency.symbol(code);
    }

    // optimistic updates
    function upsertFromClient(expense) {
      if (!expense || !expense.gmailMessageId) return;

      if (expense.currency) {
        expense.currency = AppUI.currency.normalizeCode(expense.currency);
        expense.currencySymbol = AppUI.currency.symbol(expense.currency);
      }

      var id = String(expense.gmailMessageId);
      var idx = state.items.findIndex(function (it) {
        return String(it.gmailMessageId || '') === id;
      });

      if (idx >= 0) {
        state.items[idx] = Object.assign({}, state.items[idx], expense);
      } else {
        state.items.unshift(expense);
        state.total += 1;
      }

      state.pendingId = id;
      render();
    }

    function removeFromClient(id) {
      if (!id) return;
      var idStr = String(id);

      // animar card mobile si existe
      if (cardsContainer) {
        var cardEl = cardsContainer.querySelector('[data-id="' + idStr + '"]');
        if (cardEl) {
          cardEl.classList.add('expense-card-removing');
        }
      }

      // animar fila de tabla si existe
      var rowEl = rows.querySelector('[data-id="' + idStr + '"]');
      if (rowEl) {
        rowEl.classList.add('table-row-removing');
      }

      setTimeout(function () {
        var idx = state.items.findIndex(function (it) {
          return String(it.gmailMessageId || '') === idStr;
        });
        if (idx >= 0) {
          state.items.splice(idx, 1);
          state.total = Math.max(0, state.total - 1);
        }
        render();
      }, 220);
    }

    function markPending(id) {
      state.pendingId = id || null;
      render();
    }

    function clearPending(id) {
      if (!id || String(id) === String(state.pendingId || '')) {
        state.pendingId = null;
        render();
      }
    }

    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        state.page = 1;
        state.filters = {
          whatEverText: whatEverInp.value.trim(),
          from: fromInp.value || '',
          to: toInp.value || '',
          category: categoryInput.value.trim(),
          currency: currencyInput ? currencyInput.value.trim() : ''
        };
        fetchData();
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', function () {
        whatEverInp.value = '';
        fromInp.value = '';
        toInp.value = '';
        categoryInput.value = '';
        state.page = 1;
        currencyInput.value = '';
        state.filters = { whatEverText: '', from: '', to: '', category: '', currency: '' };
        fetchData();
      });
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', function () {
        if (state.page > 1) {
          state.page--;
          fetchData();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', function () {
        if (state.page < state.totalPages) {
          state.page++;
          fetchData();
        }
      });
    }

    function handleActionClick(e) {
      var editBtn = e.target.closest('[data-edit]');
      if (editBtn) {
        var raw = editBtn.getAttribute('data-edit');
        try {
          var item = JSON.parse(
            raw.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>')
          );
          if (window.__setUpdateDataFromSearch) {
            window.__setUpdateDataFromSearch(item);
          }
        } catch (err) {
          AppUI.toast('No se pudo abrir el registro para edición.', false);
        }
        return;
      }

      var delBtn = e.target.closest('[data-delete]');
      if (delBtn) {
        var id = delBtn.getAttribute('data-delete');
        if (!id) return;
        var ok = window.confirm('¿Desea eliminar este gasto?');
        if (!ok) return;

        markPending(id);

        google.script.run
          .withSuccessHandler(function (res) {
            if (res === true) {
              removeFromClient(id);
              AppUI.toast('Gasto eliminado correctamente.', true);
            } else {
              clearPending(id);
              AppUI.toast('No se pudo eliminar el registro.', false);
            }
          })
          .withFailureHandler(function (err) {
            clearPending(id);
            var msg = (err && err.message) ? err.message : 'No se pudo eliminar el registro.';
            AppUI.toast(msg, false);
          })
          .deleteExpense({ gmailMessageId: id });
      }
    }

    rows.addEventListener('click', handleActionClick);
    if (cardsContainer) {
      cardsContainer.addEventListener('click', handleActionClick);
    }

    if (toggleFiltersBtn && filtersWrapper) {
      var isMobile = AppUI.isMobileDevice && AppUI.isMobileDevice();
      var filtersVisible = !isMobile;
      filtersWrapper.classList.add('search-filters-wrapper', 'collapsed');

      function updateFiltersToggle() {
        var icon = toggleFiltersBtn.querySelector('i');
        if (!icon) return;

        if (filtersVisible) {
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-up');
          toggleFiltersBtn.setAttribute('aria-label', 'Ocultar filtros');
        } else {
          icon.classList.remove('fa-chevron-up');
          icon.classList.add('fa-chevron-down');
          toggleFiltersBtn.setAttribute('aria-label', 'Mostrar filtros');
        }
      }

      updateFiltersToggle();

      toggleFiltersBtn.addEventListener('click', function () {
        filtersVisible = !filtersVisible;
        filtersWrapper.classList.toggle('collapsed', !filtersVisible);
        updateFiltersToggle();
      });
    }

    window.AppSearch = {
      upsertFromClient: upsertFromClient,
      removeFromClient: removeFromClient,
      markPending: markPending,
      clearPending: clearPending,
      refreshFromBackend: fetchData
    };

    window.__refreshSearch = function () {
      fetchData();
    };

    fetchData();
  });
</script>