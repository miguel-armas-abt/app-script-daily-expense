<script>
(function () {
  var initialTab = "<?= initialTab || 'search' ?>";
  if (!['save', 'search', 'update'].includes(initialTab)) initialTab = 'search';

  var initialUpdate = {
    gmailMessageId: "<?= gmailMessageId || '' ?>",
    amount:        "<?= amount || '' ?>",
    currency:      "<?= currency || '' ?>",
    expenseDate:   "<?= expenseDate || '' ?>",
    source:        "<?= source || '' ?>",
    comments:      "<?= comments || '' ?>",
    category:      "<?= category || '' ?>",
  };

    var currencies = JSON.parse('<?= JSON.stringify(currencies) ?>');

    function normalizeCode(v) {
      return String(v || '').trim().toUpperCase();
    }

    function buildMaps(list) {
      var map = {};
      for (var i = 0; i < list.length; i++) {
        var c = list[i];
        map[normalizeCode(c.code)] = String(c.symbol || '');
      }
      return map;
    }

    var currencyMap = buildMaps(currencies);

    function $(id) { return document.getElementById(id); }

  var loaderEl;
  var themeBtn;

  function showLoader(show) {
    if (!loaderEl) loaderEl = $('globalLoader');
    if (!loaderEl) return;
    loaderEl.classList.toggle('d-none', !show);
  }

  function setBusy(btn, busy) {
    if (!btn) return;
    btn.disabled = !!busy;
    btn.setAttribute('aria-busy', busy ? 'true' : 'false');
  }

  function toast(msg, ok) {
    var host = $('toastHost');
    if (!host) return;
    var el = document.createElement('div');
    el.className = 'toast align-items-center text-bg-' + (ok ? 'success' : 'danger') + ' border-0';
    el.innerHTML =
      '<div class="d-flex">' +
        '<div class="toast-body">' + (msg || '') + '</div>' +
        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
      '</div>';
    host.appendChild(el);
    var t = new bootstrap.Toast(el, { delay: 3500 });
    t.show();
    el.addEventListener('hidden.bs.toast', function () { el.remove(); });
  }

  function applyTheme(mode) {
    document.body.classList.toggle('dark-mode', mode === 'dark');
    if (themeBtn) {
      themeBtn.innerHTML = '<i class="fa-solid ' + (mode === 'dark' ? 'fa-sun' : 'fa-moon') + '"></i>';
    }
  }

  function initThemeToggle() {
    themeBtn = $('themeToggle');
    if (!themeBtn) return;
    var saved = localStorage.getItem('dex_theme') || 'light';
    applyTheme(saved);
    themeBtn.addEventListener('click', function () {
      var mode = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      localStorage.setItem('dex_theme', mode);
      applyTheme(mode);
    });
  }

  function setActiveTab(tab) {
    ['search', 'save', 'update'].forEach(function (t) {
      var pane = $('tab-' + t);
      if (pane) pane.classList.toggle('active', t === tab);
    });

    var navButtons = document.querySelectorAll('[data-nav-tab]');
    navButtons.forEach(function (btn) {
      var target = btn.getAttribute('data-nav-tab');
      btn.classList.toggle('active', target === tab);
    });
  }

  function initTabsNav() {
    var navButtons = document.querySelectorAll('[data-nav-tab]');
    navButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        var tab = btn.getAttribute('data-nav-tab');
        if (!tab) return;
        setActiveTab(tab);
      });
    });
    setActiveTab(initialTab);
  }

  function normalizeNumberString(v) {
    return String(v == null ? '' : v).replace(',', '.').trim();
  }
  function isNumeric(v) {
    var n = Number(normalizeNumberString(v));
    return !isNaN(n);
  }
  function isNumericOrEmpty(v) {
    var s = normalizeNumberString(v);
    if (!s) return true;
    var n = Number(s);
    return !isNaN(n);
  }

  function computeIsMobile() {
    var ua = navigator.userAgent || '';
    var isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);

    var sw = (window.screen && window.screen.width) ? window.screen.width : null;
    var vw = window.innerWidth || null;
    var width = Math.min(sw || Number.POSITIVE_INFINITY, vw || Number.POSITIVE_INFINITY);

    var isNarrow = width && width <= 600;
    return !!(isMobileUA || isNarrow);
  }

  function applyDeviceClasses() {
    var isMobile = computeIsMobile();
    var root = document.documentElement;
    root.classList.toggle('mobile-device', isMobile);
    root.classList.toggle('desktop-device', !isMobile);
    return isMobile;
  }

  window.AppUI = {
    initialTab: initialTab,
    initialUpdate: initialUpdate,

      currency: {
        list: currencies,
        normalizeCode: normalizeCode,
        defaultCode: function () {
          return normalizeCode(currencies[0].code);
        },
        symbol: function (code) {
          return currencyMap[normalizeCode(code)];
        }
      },

    $: $,
    showLoader: showLoader,
    setBusy: setBusy,
    toast: toast,
    setActiveTab: setActiveTab,
    refreshLayout: applyDeviceClasses,
    isMobileDevice: function () {
      return document.documentElement.classList.contains('mobile-device');
    },
    isNumeric: isNumeric,
    isNumericOrEmpty: isNumericOrEmpty
  };

  document.addEventListener('DOMContentLoaded', function () {
    applyDeviceClasses();
    loaderEl = $('globalLoader');
    initThemeToggle();
    initTabsNav();
  });

  var resizeTimeout;
  function onViewportChange() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(applyDeviceClasses, 150);
  }
  window.addEventListener('resize', onViewportChange);
  window.addEventListener('orientationchange', onViewportChange);
})();
</script>