<script>
  (function () {
    var initialAction = "<?= initialTab || 'search' ?>";
    if (!['search', 'save', 'update'].includes(initialAction)) initialAction = 'search';

    var initialUpdate = {
      gmailMessageId: "<?= gmailMessageId || '' ?>",
      amount: "<?= amount || '' ?>",
      currency: "<?= currency || '' ?>",
      expenseDate: "<?= expenseDate || '' ?>",
      source: "<?= source || '' ?>",
      comments: "<?= comments || '' ?>",
      category: "<?= category || '' ?>",
    };

    var currencies = JSON.parse('<?= JSON.stringify(currencies) ?>');
    var initialCategories = JSON.parse('<?= JSON.stringify(categories || []) ?>');

    function normalizeCode(v) { return String(v || '').trim().toUpperCase(); }
    function normalizeText(v) { return String(v || '').trim(); }

    function buildCurrencyMap(list) {
      var map = {};
      for (var i = 0; i < list.length; i++) {
        var c = list[i] || {};
        map[normalizeCode(c.code)] = String(c.symbol || '');
      }
      return map;
    }

    var currencyMap = buildCurrencyMap(currencies);
    function $(id) { return document.getElementById(id); }

    var loaderEl;
    var themeBtn;

    function showLoader(show) {
      if (!loaderEl) loaderEl = $('globalLoader');
      if (!loaderEl) return;
      loaderEl.classList.toggle('hidden', !show);
      loaderEl.classList.toggle('flex', !!show);
    }

    function setBusy(btn, busy) {
      if (!btn) return;
      btn.disabled = !!busy;
      btn.setAttribute('aria-busy', busy ? 'true' : 'false');
    }

    function setModalBusy(modalId, busy) {
      var el = $(modalId);
      if (!el) return;
      el.setAttribute('data-busy', busy ? 'true' : 'false');

      var controls = el.querySelectorAll('input, select, textarea, button');
      controls.forEach(function (c) {
        if (c && c.getAttribute && c.getAttribute('data-close-modal')) return;
        c.disabled = !!busy;
        c.setAttribute('aria-busy', busy ? 'true' : 'false');
      });
    }

    function setModalLoading(modalId, loading) {
      var el = $(modalId);
      if (!el) return;
      var loader = el.querySelector('[data-modal-loader="true"]');
      var content = el.querySelector('[data-modal-content="true"]');
      if (loader) loader.classList.toggle('hidden', !loading);
      if (content) content.classList.toggle('hidden', !!loading);
      el.setAttribute('data-loading', loading ? 'true' : 'false');
    }

    function initSidebarHover() {
      var sidebar = $('desktopSidebar');
      if (!sidebar) return;

      var expandTimer = null;

      function setExpanded(expanded) {
        sidebar.classList.toggle('md:w-56', expanded);
        sidebar.classList.toggle('md:w-[72px]', !expanded);

        var labels = sidebar.querySelectorAll('[data-sidebar-label]');
        labels.forEach(function (l) { l.classList.toggle('hidden', !expanded); });

        var logo = sidebar.querySelector('[data-sidebar-logo-text]');
        if (logo) logo.classList.toggle('hidden', !expanded);
      }

      function onEnter() {
        window.clearTimeout(expandTimer);
        expandTimer = window.setTimeout(function () { setExpanded(true); }, 1000);
      }

      function onLeave() {
        window.clearTimeout(expandTimer);
        setExpanded(false);
      }

      sidebar.addEventListener('mouseenter', onEnter);
      sidebar.addEventListener('mouseleave', onLeave);

      var expensesBtn = sidebar.querySelector('[data-nav="expenses"]');
      if (expensesBtn) {
        expensesBtn.addEventListener('click', function () {
          var btn = $('tab-search-btn');
          if (btn) btn.click();
          syncSideButtons('search');
        });
      }

      var loansBtn = sidebar.querySelector('[data-nav="loans"]');
      if (loansBtn) {
        loansBtn.addEventListener('click', function () {
          toast('Gestión de préstamos estará disponible próximamente.', false);
        });
      }

      setExpanded(false);
    }

    function initBottomNav() {
      var nav = $('mobileBottomNav');
      if (!nav) return;

      function setActive(key) {
        var buttons = nav.querySelectorAll('[data-bottom-nav]');
        buttons.forEach(function (btn) {
          var isActive = btn.getAttribute('data-bottom-nav') === key;
          btn.classList.toggle('text-gray-900', isActive);
          btn.classList.toggle('dark:text-gray-100', isActive);
          btn.classList.toggle('text-gray-600', !isActive);
          btn.classList.toggle('dark:text-gray-300', !isActive);
          btn.classList.toggle('bg-gray-100', isActive);
          btn.classList.toggle('dark:bg-gray-900', isActive);
        });
      }

      nav.addEventListener('click', function (e) {
        var t = e && e.target;
        if (!t || !t.closest) return;
        var btn = t.closest('[data-bottom-nav]');
        if (!btn) return;

        var key = btn.getAttribute('data-bottom-nav');
        if (key === 'expenses') {
          setActive('expenses');
          var tabBtn = $('tab-search-btn');
          if (tabBtn) tabBtn.click();
          return;
        }

        if (key === 'loans') toast('Gestión de préstamos estará disponible próximamente.', false);
        if (key === 'investments') toast('Inversiones estará disponible próximamente.', false);
      });

      setActive('expenses');
    }

    var modalInstances = {};

    function ensureModal(modalId, opts) {
      if (!modalId) return null;
      if (modalInstances[modalId]) return modalInstances[modalId];

      var el = $(modalId);
      if (!el || !window.Modal) return null;

      try {
        var instance = new window.Modal(el, opts || { backdrop: 'dynamic', closable: true });
        modalInstances[modalId] = instance;
        return instance;
      } catch (e) {
        return null;
      }
    }

    function openModal(modalId) {
      var modal = ensureModal(modalId);
      if (!modal) return;
      modal.show();
    }

    function closeModal(modalId) {
      var el = $(modalId);
      if (el && (el.getAttribute('data-busy') === 'true' || el.getAttribute('data-loading') === 'true')) return;

      var modal = ensureModal(modalId);
      if (!modal) return;
      try { modal.hide(); } catch (e) {}
    }

    function toast(msg, ok) {
      var modalEl = $('statusModal');
      if (!modalEl) return;

      var iconEl = $('statusModalIcon');
      var msgEl = $('statusModalMessage');

      if (iconEl) {
        iconEl.className = 'fa-solid ' + (ok ? 'fa-circle-check' : 'fa-circle-xmark') + ' text-2xl';
      }
      if (msgEl) msgEl.textContent = msg || '';

      var modal = ensureModal('statusModal', { backdrop: 'dynamic', closable: true });
      if (!modal) return;
      modal.show();

      window.clearTimeout(window.__statusModalTimer);
      window.__statusModalTimer = window.setTimeout(function () {
        try { modal.hide(); } catch (e) {}
      }, 1800);
    }

    function setTheme(mode) {
      var dark = mode === 'dark';
      document.documentElement.classList.toggle('dark', dark);
      var icon = '<i class="fa-solid ' + (dark ? 'fa-sun' : 'fa-moon') + '"></i>';
      if (themeBtn) themeBtn.innerHTML = icon;
    }

    function initThemeToggle() {
      themeBtn = $('themeToggle');

      var saved = localStorage.getItem('dex_theme') || 'light';
      setTheme(saved);

      function onToggle() {
        var current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        var next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('dex_theme', next);
        setTheme(next);
      }

      if (themeBtn) themeBtn.addEventListener('click', onToggle);
    }

    function syncSideButtons(activeKey) {
      var side = document.querySelectorAll('aside [data-tab-key]');
      side.forEach(function (b) {
        var isActive = b.getAttribute('data-tab-key') === activeKey;
        b.classList.toggle('bg-gray-50', isActive);
        b.classList.toggle('text-gray-900', isActive);
        b.classList.toggle('dark:bg-gray-900', isActive);
        b.classList.toggle('dark:text-white', isActive);
      });
    }

    function initTabSync() {
      document.addEventListener('shown.tw.tab', function (e) {
        try {
          var target = e && e.target ? e.target.getAttribute('data-tabs-target') : '';
          var key = target === '#tab-search' ? 'search' : 'search';
          syncSideButtons(key);
        } catch (err) {}
      });

      var btn = $('tab-search-btn');
      if (btn) btn.click();
      syncSideButtons('search');
    }

    function normalizeNumberString(v) { return String(v == null ? '' : v).replace(',', '.').trim(); }
    function isNumeric(v) { var n = Number(normalizeNumberString(v)); return !isNaN(n); }
    function isNumericOrEmpty(v) { var s = normalizeNumberString(v); if (!s) return true; var n = Number(s); return !isNaN(n); }

    var PositiveDecimal = (function () {
      var REGEX = /^\d+(\.\d+)?$/;

      function sanitize(value) {
        if (value == null) return "";
        var out = String(value).replace(/[^\d.]/g, "");
        var firstDot = out.indexOf(".");
        if (firstDot !== -1) {
          out = out.substring(0, firstDot + 1) + out.substring(firstDot + 1).replace(/\./g, "");
        }
        out = out.replace(/^\./, "");
        return out;
      }

      function bind(inputOrSelector) {
        var input = (typeof inputOrSelector === "string") ? document.querySelector(inputOrSelector) : inputOrSelector;
        if (!input) return;

        function handler() {
          var sanitized = sanitize(input.value);
          if (input.value !== sanitized) {
            var start = input.selectionStart;
            var end = input.selectionEnd;
            input.value = sanitized;
            try { input.setSelectionRange(start, end); } catch (e) {}
          }
          if (input.value === "" || REGEX.test(input.value)) input.setCustomValidity("");
          else input.setCustomValidity("Ingrese un número positivo");
        }

        input.addEventListener("input", handler);
        input.addEventListener("blur", handler);
        handler();
      }

      function autoBind() {
        var inputs = document.querySelectorAll('input[data-positive-decimal="true"]');
        inputs.forEach(function (el) { bind(el); });
      }

      return Object.freeze({ REGEX: REGEX, sanitize: sanitize, bind: bind, autoBind: autoBind });
    })();

    function wireCreateButtons() {
      function openCreate() {
        if (window.AppCreate && window.AppCreate.open) window.AppCreate.open();
        else openModal('createExpenseModal');
      }

      var topBtn = $('openCreateModalTop');
      if (topBtn) topBtn.addEventListener('click', openCreate);

      var mobileBtn = $('openCreateModalMobile');
      if (mobileBtn) mobileBtn.addEventListener('click', openCreate);
    }

    function wireModalCloseButtons() {
      var btns = document.querySelectorAll('[data-close-modal]');
      btns.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var modalId = btn.getAttribute('data-close-modal');
          closeModal(modalId);
        });
      });
    }

    function initModals() {
      ensureModal('statusModal', { backdrop: 'dynamic', closable: true });
      ensureModal('createExpenseModal', { backdrop: 'dynamic', closable: true });
      ensureModal('updateExpenseModal', { backdrop: 'dynamic', closable: true });
      ensureModal('configModal', { backdrop: 'dynamic', closable: true });
    }

    function normalizeCategoryResponse(res) {
      if (!res) return [];
      if (Array.isArray(res)) return res;
      if (res.categories && Array.isArray(res.categories)) return res.categories;
      return [];
    }

    function mapToCategoryItems(rawList) {
      return (rawList || []).map(function (c) {
        return { description: normalizeText(c.description), limit: Number(c.limit || 0) };
      }).filter(function (c) { return !!c.description; });
    }

    function applyCategoriesToSelect(select, list) {
      if (!select) return;

      var includeAll = select.hasAttribute('data-category-include-all');
      var includePlaceholder = select.hasAttribute('data-category-placeholder');

      var prev = String(select.value || '');
      select.innerHTML = '';

      if (includeAll) {
        var allOpt = document.createElement('option');
        allOpt.value = '';
        allOpt.textContent = 'Todas';
        select.appendChild(allOpt);
      }

      if (includePlaceholder) {
        var pl = document.createElement('option');
        pl.value = '';
        pl.textContent = 'Seleccione';
        pl.disabled = true;
        pl.selected = !prev;
        select.appendChild(pl);
      }

      for (var i = 0; i < (list || []).length; i++) {
        var opt = document.createElement('option');
        opt.value = list[i].description;
        opt.textContent = list[i].description;
        select.appendChild(opt);
      }

      if (prev) select.value = prev;
      if (!select.value && includePlaceholder) select.selectedIndex = 0;
    }

    var CategoriesStore = (function () {
      var cache = mapToCategoryItems(initialCategories);
      var loading = false;
      var pendingCallbacks = [];
      var lastFetchAt = 0;
      var MIN_REFRESH_MS = 15000;

      function list() { return cache.slice(); }

      function applyAll() {
        var selects = document.querySelectorAll('select[data-category-select="true"]');
        selects.forEach(function (s) { applyCategoriesToSelect(s, cache); });
      }

      function setCache(next, options) {
        var opts = options || {};
        cache = mapToCategoryItems(next || []);
        if (opts.apply) applyAll();
        if (opts.touchFetch) lastFetchAt = Date.now();
      }

      function loadFromBackend(done) {
        if (loading) {
          if (typeof done === 'function') pendingCallbacks.push(done);
          return;
        }

        loading = true;
        if (typeof done === 'function') pendingCallbacks.push(done);

        google.script.run
          .withSuccessHandler(function (res) {
            var next = mapToCategoryItems(normalizeCategoryResponse(res));
            setCache(next, { apply: true, touchFetch: true });

            loading = false;
            var cbs = pendingCallbacks.slice();
            pendingCallbacks = [];
            cbs.forEach(function (cb) { try { cb(list()); } catch (e) {} });
          })
          .withFailureHandler(function () {
            loading = false;
            var cbs = pendingCallbacks.slice();
            pendingCallbacks = [];
            cbs.forEach(function (cb) { try { cb(list()); } catch (e) {} });
          })
          .getCategories();
      }

      function ensureLoaded(done, options) {
        var opts = options || {};
        var force = !!opts.force;

        var now = Date.now();
        var freshEnough = cache && cache.length && (now - lastFetchAt) < MIN_REFRESH_MS;

        if (!force && freshEnough) {
          applyAll();
          if (typeof done === 'function') done(list());
          return;
        }

        loadFromBackend(function (out) {
          applyAll();
          if (typeof done === 'function') done(out);
        });
      }

      return Object.freeze({
        list: list,
        applyAll: applyAll,
        ensureLoaded: ensureLoaded,
        setCache: function (next, apply) { setCache(next, { apply: !!apply, touchFetch: true }); }
      });
    })();

    var Expenses = (function () {
      function toNumber(value) {
        var s = String(value == null ? '' : value).trim().replace(',', '.');
        if (!s) return NaN;
        var n = Number(s);
        return isNaN(n) ? NaN : n;
      }

      function findCategoryLimit(category) {
        var key = normalizeText(category);
        if (!key) return 0;
        var list = CategoriesStore.list();
        for (var i = 0; i < list.length; i++) {
          if (normalizeText(list[i].description) === key) return Number(list[i].limit || 0);
        }
        return 0;
      }

      function computeIsBelowLimit(amount, category) {
        var n = toNumber(amount);
        if (isNaN(n)) return false;
        var limit = findCategoryLimit(category);
        return n <= Number(limit || 0);
      }

      return Object.freeze({ computeIsBelowLimit: computeIsBelowLimit });
    })();

    window.AppUI = {
      initialAction: initialAction,
      initialUpdate: initialUpdate,

      currency: {
        list: currencies,
        normalizeCode: normalizeCode,
        defaultCode: function () { return normalizeCode(currencies[0] && currencies[0].code); },
        symbol: function (code) { return currencyMap[normalizeCode(code)]; }
      },

      categories: {
        list: function () { return CategoriesStore.list(); },
        applyAll: function () { CategoriesStore.applyAll(); },
        ensureLoaded: function (cb, opts) { CategoriesStore.ensureLoaded(cb, opts); },
        setCache: function (next, apply) { CategoriesStore.setCache(next, apply); }
      },

      expenses: Expenses,

      $: $,
      showLoader: showLoader,
      setBusy: setBusy,
      setModalBusy: setModalBusy,
      setModalLoading: setModalLoading,
      toast: toast,
      openModal: openModal,
      closeModal: closeModal,
      isNumeric: isNumeric,
      isNumericOrEmpty: isNumericOrEmpty,
      PositiveDecimal: PositiveDecimal,
      isPositiveDecimal: function (v) { return PositiveDecimal.REGEX.test(String(v || '').trim()); },
      isPositiveDecimalOrEmpty: function (v) {
        var s = String(v || '').trim();
        return s === '' || PositiveDecimal.REGEX.test(s);
      }
    };

    document.addEventListener('DOMContentLoaded', function () {
      loaderEl = $('globalLoader');
      initModals();
      initThemeToggle();
      initTabSync();
      wireCreateButtons();
      wireModalCloseButtons();
      initSidebarHover();
      initBottomNav();
      try { PositiveDecimal.autoBind(); } catch (e) {}

      if (window.AppUI && window.AppUI.categories && window.AppUI.categories.ensureLoaded) {
        window.AppUI.categories.ensureLoaded();
      }

      if (initialAction === 'save') {
        window.setTimeout(function () {
          if (window.AppCreate && window.AppCreate.open) window.AppCreate.open();
          else openModal('createExpenseModal');
        }, 0);
      }

      if (initialAction === 'update') {
        window.setTimeout(function () {
          if (window.AppUpdate && window.AppUpdate.openWithItem) window.AppUpdate.openWithItem(initialUpdate);
        }, 0);
      }
    });
  })();
</script>
