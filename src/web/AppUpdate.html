<script>
  document.addEventListener('DOMContentLoaded', function () {
    var AppUI = window.AppUI;
    if (!AppUI) return;
    var $ = AppUI.$;

    var form = $('expense-form');
    if (!form) return;

    var saveBtn = $('saveBtnUpdate');

    var amountInput = $('amountInputUpdate');
    var categoryInput = $('categoryInputUpdate');
    var commentsInput = $('commentsUpdate');
    var gmailInput = $('gmailMessageIdUpdate');
    var currencyInput = $('currencyInputUpdate');

    var sumDate = $('summaryDate');
    var sumSource = $('summarySource');
    var sumId = $('summaryId');

    function setInvalidVisible(input, visible) {
      if (!input) return;
      var el = document.querySelector('[data-invalid-for="' + input.id + '"]');
      if (!el) return;
      el.classList.toggle('hidden', !visible);
    }

    function syncValidation() {
      var inputs = [amountInput, categoryInput];
      inputs.forEach(function (inp) {
        if (!inp) return;
        setInvalidVisible(inp, !inp.checkValidity());
      });
      if (saveBtn) saveBtn.disabled = !form.checkValidity();
      return form.checkValidity();
    }

    function fillUpdateFields(data) {
      gmailInput.value = data.gmailMessageId || '';
      amountInput.value = data.amount != null ? String(data.amount) : '';
      commentsInput.value = data.comments || '';

      if (sumDate) sumDate.textContent = data.expenseDate || '—';
      if (sumSource) sumSource.textContent = data.source || '—';
      if (sumId) {
        sumId.textContent = data.gmailMessageId || '—';
        sumId.title = data.gmailMessageId || '';
      }

      if (currencyInput) {
        var code = data.currency ? AppUI.currency.normalizeCode(data.currency) : AppUI.currency.defaultCode();
        currencyInput.value = code;
      }

      if (categoryInput) categoryInput.value = data.category || '';

      [amountInput, categoryInput].forEach(function (i) { setInvalidVisible(i, false); });
      syncValidation();
    }

    var originalUpdateData = {
      gmailMessageId: AppUI.initialUpdate.gmailMessageId || '',
      currency: AppUI.initialUpdate.currency || '',
      amount: AppUI.initialUpdate.amount || '',
      expenseDate: AppUI.initialUpdate.expenseDate || '',
      source: AppUI.initialUpdate.source || '',
      comments: AppUI.initialUpdate.comments || '',
      category: AppUI.initialUpdate.category || ''
    };

    function openUpdateModal() { AppUI.setModalBusy('updateExpenseModal', false); AppUI.openModal('updateExpenseModal'); }
    function closeUpdateModal() { AppUI.closeModal('updateExpenseModal'); }

    function openWithItem(item) {
      if (!item || !item.gmailMessageId) {
        AppUI.toast('No se encontró el ID del gasto.', false);
        return;
      }

      originalUpdateData = {
        gmailMessageId: item.gmailMessageId || '',
        amount: item.amount != null ? String(item.amount) : '',
        currency: item.currency || '',
        expenseDate: item.expenseDate || '',
        source: item.source || '',
        comments: item.comments || '',
        category: item.category || ''
      };

      if (AppUI.categories && AppUI.categories.ensureLoaded) {
        AppUI.categories.ensureLoaded(function () {
          fillUpdateFields(originalUpdateData);
          openUpdateModal();
        });
        return;
      }

      fillUpdateFields(originalUpdateData);
      openUpdateModal();
    }

    function initForm() {
      if (AppUI.categories && AppUI.categories.ensureLoaded) {
        AppUI.categories.ensureLoaded(function () {
          if (originalUpdateData.gmailMessageId) fillUpdateFields(originalUpdateData);
          else fillUpdateFields({ gmailMessageId: '', amount: '', expenseDate: '', source: '', comments: '', category: '', currency: AppUI.currency.defaultCode() });
        });
        return;
      }

      if (originalUpdateData.gmailMessageId) fillUpdateFields(originalUpdateData);
      else fillUpdateFields({ gmailMessageId: '', amount: '', expenseDate: '', source: '', comments: '', category: '', currency: AppUI.currency.defaultCode() });
    }

    initForm();

    ['input', 'change', 'blur'].forEach(function (evt) {
      form.addEventListener(evt, function () { syncValidation(); }, true);
    });

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      e.stopPropagation();

      if (!syncValidation()) return;

      var payload = {
        gmailMessageId: gmailInput.value,
        category: String(categoryInput.value || '').trim(),
        comments: commentsInput.value.trim(),
        amount: amountInput.value.trim(),
        currency: AppUI.currency.normalizeCode(currencyInput.value)
      };

      if (!payload.gmailMessageId) {
        AppUI.toast('No hay un ID de gasto para actualizar.', false);
        return;
      }

      var updatedForGrid = {
        gmailMessageId: payload.gmailMessageId,
        amount: payload.amount || originalUpdateData.amount,
        currency: payload.currency,
        currencySymbol: AppUI.currency.symbol(payload.currency),
        category: payload.category,
        comments: payload.comments,
        expenseDate: originalUpdateData.expenseDate,
        source: originalUpdateData.source
      };

      if (window.AppSearch && window.AppSearch.upsertFromClient) window.AppSearch.upsertFromClient(updatedForGrid);
      AppUI.setModalBusy('updateExpenseModal', true);
      AppUI.setBusy(saveBtn, true);

      google.script.run
        .withSuccessHandler(function () {
          AppUI.setModalBusy('updateExpenseModal', false);
          AppUI.setBusy(saveBtn, false);
          if (window.AppSearch && window.AppSearch.clearPending) window.AppSearch.clearPending(payload.gmailMessageId);
          AppUI.toast('Gasto actualizado con éxito.', true);
          closeUpdateModal();
        })
        .withFailureHandler(function (err) {
          AppUI.setModalBusy('updateExpenseModal', false);
          AppUI.setBusy(saveBtn, false);

          if (window.AppSearch && window.AppSearch.upsertFromClient) {
            window.AppSearch.upsertFromClient(originalUpdateData);
            if (window.AppSearch.clearPending) window.AppSearch.clearPending(payload.gmailMessageId);
          }

          var msg = (err && err.message) ? err.message : 'No se pudo actualizar.';
          AppUI.toast(msg, false);
        })
        .updateExpense(payload);
    });

    window.AppUpdate = {
      openWithItem: openWithItem,
      close: closeUpdateModal
    };

    syncValidation();
  });
</script>
