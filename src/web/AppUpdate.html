<script>
  document.addEventListener('DOMContentLoaded', function () {
    var AppUI = window.AppUI;
    if (!AppUI) return;
    var $ = AppUI.$;

    var form = $('expense-form');
    if (!form) return;

    var saveBtn = $('saveBtnUpdate');

    var amountInput = $('amountInputUpdate');
    var categoryInput = $('categoryInputUpdate');
    var commentsInput = $('commentsUpdate');
    var gmailInput = $('gmailMessageIdUpdate');
    var currencyInput = $('currencyInputUpdate');

    var subtitleEl = $('updateExpenseModalSubtitle');

    var touched = {};

    function markTouched(input) {
      if (!input || !input.id) return;
      touched[input.id] = true;
    }

    function setInvalidVisible(input, visible) {
      if (!input) return;
      var el = document.querySelector('[data-invalid-for="' + input.id + '"]');
      if (!el) return;
      el.classList.toggle('hidden', !visible);
    }

    function shouldShowInvalid(input) {
      if (!input || !input.id) return false;
      return !!touched[input.id];
    }

    function syncValidation() {
      var inputs = [amountInput, categoryInput];
      inputs.forEach(function (inp) {
        if (!inp) return;
        var show = shouldShowInvalid(inp) && !inp.checkValidity();
        setInvalidVisible(inp, show);
      });
      if (saveBtn) saveBtn.disabled = !form.checkValidity();
      return form.checkValidity();
    }

    function setSavingState(saving) {
      AppUI.showLoader(!!saving);
      AppUI.setModalBusy('updateExpenseModal', !!saving);
      AppUI.setBusy(saveBtn, !!saving);
    }

    function formatModalSubtitle(expenseDate, source) {
      var left = String(expenseDate || '').trim();
      var right = String(source || '').trim();
      if (!left && !right) return '—';
      var leftOut = left;
      var m = left.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) leftOut = m[3] + '/' + m[2] + '/' + m[1];
      return right ? (leftOut + ' | ' + right) : leftOut;
    }

    function applySubtitle(expenseDate, source) {
      if (!subtitleEl) return;
      var text = formatModalSubtitle(expenseDate, source);
      subtitleEl.textContent = text;
      subtitleEl.title = text;
    }

    function resetTouched() {
      touched = {};
    }

    function fillUpdateFields(data) {
      gmailInput.value = data.gmailMessageId || '';
      amountInput.value = data.amount != null ? String(data.amount) : '';
      commentsInput.value = data.comments || '';

      applySubtitle(data.expenseDate || '', data.source || '');

      if (currencyInput) {
        var code = data.currency ? AppUI.currency.normalizeCode(data.currency) : AppUI.currency.defaultCode();
        currencyInput.value = code;
      }

      if (categoryInput) categoryInput.value = data.category || '';

      resetTouched();
      [amountInput, categoryInput].forEach(function (i) { setInvalidVisible(i, false); });
      syncValidation();
    }

    var originalUpdateData = {
      gmailMessageId: AppUI.initialUpdate.gmailMessageId || '',
      currency: AppUI.initialUpdate.currency || '',
      amount: AppUI.initialUpdate.amount || '',
      expenseDate: AppUI.initialUpdate.expenseDate || '',
      source: AppUI.initialUpdate.source || '',
      comments: AppUI.initialUpdate.comments || '',
      category: AppUI.initialUpdate.category || ''
    };

    function openUpdateModal() { AppUI.setModalBusy('updateExpenseModal', false); AppUI.openModal('updateExpenseModal'); }
    function closeUpdateModal() { AppUI.closeModal('updateExpenseModal'); }

    function openWithItem(item) {
      if (!item || !item.gmailMessageId) {
        AppUI.toast('No se encontró el ID del gasto.', false);
        return;
      }

      originalUpdateData = {
        gmailMessageId: item.gmailMessageId || '',
        amount: item.amount != null ? String(item.amount) : '',
        currency: item.currency || '',
        expenseDate: item.expenseDate || '',
        source: item.source || '',
        comments: item.comments || '',
        category: item.category || ''
      };

      AppUI.setModalLoading('updateExpenseModal', true);
      openUpdateModal();

      if (AppUI.categories && AppUI.categories.ensureLoaded) {
        AppUI.categories.ensureLoaded(function () {
          fillUpdateFields(originalUpdateData);
          AppUI.setModalLoading('updateExpenseModal', false);
        });
        return;
      }

      fillUpdateFields(originalUpdateData);
      AppUI.setModalLoading('updateExpenseModal', false);
    }

    function initForm() {
      if (AppUI.categories && AppUI.categories.ensureLoaded) {
        AppUI.categories.ensureLoaded(function () {
          if (originalUpdateData.gmailMessageId) fillUpdateFields(originalUpdateData);
          else fillUpdateFields({ gmailMessageId: '', amount: '', expenseDate: '', source: '', comments: '', category: '', currency: AppUI.currency.defaultCode() });
        });
        return;
      }

      if (originalUpdateData.gmailMessageId) fillUpdateFields(originalUpdateData);
      else fillUpdateFields({ gmailMessageId: '', amount: '', expenseDate: '', source: '', comments: '', category: '', currency: AppUI.currency.defaultCode() });
    }

    function wireTouched(input) {
      if (!input) return;
      input.addEventListener('input', function () { markTouched(input); syncValidation(); }, true);
      input.addEventListener('blur', function () { markTouched(input); syncValidation(); }, true);
      input.addEventListener('change', function () { markTouched(input); syncValidation(); }, true);
    }

    [amountInput, categoryInput].forEach(wireTouched);

    initForm();

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      e.stopPropagation();

      [amountInput, categoryInput].forEach(markTouched);

      if (!syncValidation()) return;

      var payload = {
        gmailMessageId: gmailInput.value,
        category: String(categoryInput.value || '').trim(),
        comments: commentsInput.value.trim(),
        amount: amountInput.value.trim(),
        currency: AppUI.currency.normalizeCode(currencyInput.value)
      };

      if (!payload.gmailMessageId) {
        AppUI.toast('No hay un ID de gasto para actualizar.', false);
        return;
      }

      var updatedForGrid = {
        gmailMessageId: payload.gmailMessageId,
        amount: payload.amount || originalUpdateData.amount,
        currency: payload.currency,
        currencySymbol: AppUI.currency.symbol(payload.currency),
        category: payload.category,
        comments: payload.comments,
        expenseDate: originalUpdateData.expenseDate,
        source: originalUpdateData.source
      };

      if (window.AppSearch && window.AppSearch.upsertFromClient) window.AppSearch.upsertFromClient(updatedForGrid);

      setSavingState(true);

      google.script.run
        .withSuccessHandler(function () {
          setSavingState(false);

          if (window.AppSearch && window.AppSearch.clearPending) window.AppSearch.clearPending(payload.gmailMessageId);
          if (window.AppSearch && window.AppSearch.refreshFromBackend) window.AppSearch.refreshFromBackend();

          AppUI.toast('Gasto actualizado con éxito.', true);
          closeUpdateModal();
        })
        .withFailureHandler(function (err) {
          setSavingState(false);

          if (window.AppSearch && window.AppSearch.upsertFromClient) {
            window.AppSearch.upsertFromClient(originalUpdateData);
            if (window.AppSearch.clearPending) window.AppSearch.clearPending(payload.gmailMessageId);
          }

          var msg = (err && err.message) ? err.message : 'No se pudo actualizar.';
          AppUI.toast(msg, false);
        })
        .updateExpense(payload);
    });

    window.AppUpdate = {
      openWithItem: openWithItem,
      close: closeUpdateModal
    };

    syncValidation();
  });
</script>
